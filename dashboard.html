<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Lengkap</title>
  <style>
    #progressContainer { display: none; text-align: center; margin: 20px; }
    .file-card { border-bottom: 1px solid #ccc; padding: 10px 0; margin-bottom: 10px; }
    .file-card h4 { margin: 0 0 5px; }
    .file-card button { margin: 5px 5px 0 0; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBvP6inaHIQAlJZG5S96iAEcykO2AWaAyk",
      authDomain: "memeweb-94369.firebaseapp.com",
      projectId: "memeweb-94369",
      storageBucket: "memeweb-94369.appspot.com",
      messagingSenderId: "209198224630",
      appId: "1:209198224630:web:c4f4b0835def55523c88d7",
      measurementId: "G-G052ZX30V7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let allDocs = [];

    function validasi(text, nama) {
      if (!text || text.trim() === "") {
        alert(`${nama} wajib diisi.`);
        return false;
      }
      return true;
    }

    window.uploadFile = async function () {
      const fileInput = document.createElement("input");
      fileInput.type = "file";

      fileInput.onchange = async () => {
        const file = fileInput.files[0];
        if (!file) return;

        const kategori = prompt("Masukkan kategori:");
        if (!validasi(kategori, "Kategori")) return;

        const judul = prompt("Masukkan judul file:");
        if (!validasi(judul, "Judul")) return;

        const deskripsi = prompt("Masukkan deskripsi:");
        if (!validasi(deskripsi, "Deskripsi")) return;

        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");
        progressContainer.style.display = "block";
        progressBar.value = 0;
        progressText.textContent = "Sabar ya... (0%)";

        const storageRef = ref(storage, "uploads/" + file.name);
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on(
          "state_changed",
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressBar.value = progress;
            progressText.textContent = `Sabar ya... (${Math.round(progress)}%)`;
          },
          (error) => {
            alert("❌ Upload gagal.");
            console.error(error);
            progressContainer.style.display = "none";
          },
          async () => {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            await addDoc(collection(db, "koleksi"), {
              kategori, judul, deskripsi,
              url: downloadURL,
              namaFile: file.name,
              tanggal: new Date().toISOString()
            });
            alert("✅ File berhasil diunggah!");
            progressContainer.style.display = "none";
            tampilkanUpload();
          }
        );
      };

      fileInput.click();
    };

    window.hapusFile = async function (id, fileName) {
      if (!confirm("Yakin ingin menghapus file ini?")) return;
      try {
        await deleteDoc(doc(db, "koleksi", id));
        await deleteObject(ref(storage, "uploads/" + fileName));
        alert("🗑️ Berhasil dihapus.");
        tampilkanUpload();
      } catch (e) {
        alert("❌ Gagal menghapus.");
        console.error(e);
      }
    };

    window.editFile = async function (id, oldData) {
      const judul = prompt("Edit judul:", oldData.judul);
      if (!validasi(judul, "Judul")) return;

      const kategori = prompt("Edit kategori:", oldData.kategori);
      if (!validasi(kategori, "Kategori")) return;

      const deskripsi = prompt("Edit deskripsi:", oldData.deskripsi);
      if (!validasi(deskripsi, "Deskripsi")) return;

      try {
        await updateDoc(doc(db, "koleksi", id), { judul, kategori, deskripsi });
        alert("✏️ Data berhasil diperbarui.");
        tampilkanUpload();
      } catch (e) {
        alert("❌ Gagal update.");
        console.error(e);
      }
    };

    window.tampilkanUpload = async function () {
      const fileList = document.getElementById("fileList");
      const filter = document.getElementById("filterKategori").value;
      fileList.innerHTML = "<p>🔄 Memuat data...</p>";

      try {
        const snapshot = await getDocs(collection(db, "koleksi"));
        allDocs = [];
        snapshot.forEach((docSnap) => {
          allDocs.push({ id: docSnap.id, ...docSnap.data() });
        });

        const filtered = filter === "semua"
          ? allDocs
          : allDocs.filter(f => f.kategori.toLowerCase() === filter.toLowerCase());

        fileList.innerHTML = "";
        if (filtered.length === 0) {
          fileList.innerHTML = "<p>Tidak ada file ditemukan.</p>";
          return;
        }

        filtered.forEach((d) => {
          const el = document.createElement("div");
          el.className = "file-card";
          el.innerHTML = `
            <h4>📄 ${d.judul}</h4>
            <p><b>Kategori:</b> ${d.kategori}</p>
            <p><b>Deskripsi:</b> ${d.deskripsi}</p>
            <a href="${d.url}" target="_blank">📂 Lihat File</a><br/>
            <button onclick="editFile('${d.id}', ${JSON.stringify(d)})">✏️ Edit</button>
            <button onclick="hapusFile('${d.id}', '${d.namaFile}')">🗑️ Hapus</button>
          `;
          fileList.appendChild(el);
        });
      } catch (e) {
        fileList.innerHTML = "<p>❌ Gagal menampilkan data.</p>";
        console.error(e);
      }
    };

    window.addEventListener("DOMContentLoaded", tampilkanUpload);
  </script>
</head>
<body>
  <h2 style="text-align:center;">📁 Dashboard Lengkap</h2>
  <div style="text-align:center; margin:10px;">
    <button onclick="uploadFile()">⬆️ Upload File</button>
    <select id="filterKategori" onchange="tampilkanUpload()">
      <option value="semua">🔍 Semua Kategori</option>
      <option value="perjalanan">Perjalanan</option>
      <option value="keluarga">Keluarga</option>
      <option value="pribadi">Pribadi</option>
      <option value="dokumen">Dokumen</option>
    </select>
  </div>

  <div id="progressContainer">
    <progress id="progressBar" value="0" max="100" style="width: 80%; height: 20px;"></progress>
    <p id="progressText" style="font-weight: bold; margin-top: 10px;">Sabar ya...</p>
  </div>

  <div id="fileList" style="padding: 20px;"></div>
</body>
</html>
